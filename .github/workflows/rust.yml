name: Rust Build

on:
  push:
    branches: 
      - "master"
      - "fix/win7-compatibility"
    tags:
      - 'v*'
  pull_request:
    branches: 
      - "master"
      - "fix/win7-compatibility"

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    runs-on: windows-latest
    permissions: write-all

    steps:
    - uses: actions/checkout@v4
    
    - name: 安装 Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        targets: i686-pc-windows-msvc, x86_64-pc-windows-msvc
        components: rust-src
        
    - name: 缓存依赖
      uses: Swatinem/rust-cache@v2
      
    - name: 构建 x64 版本
      run: |
        set RUSTFLAGS=-C target-feature=+crt-static
        cargo build --release --target x86_64-pc-windows-msvc --features panic_abort
      
    - name: 构建 x32 版本
      run: |
        set RUSTFLAGS=-C target-feature=+crt-static
        cargo build --release --target i686-pc-windows-msvc --features panic_abort
      
    - name: 检查构建产物
      run: |
        if not exist "target/x86_64-pc-windows-msvc/release/auto_backup.exe" (
          echo "x64 构建失败"
          exit 1
        )
        if not exist "target/i686-pc-windows-msvc/release/auto_backup.exe" (
          echo "x32 构建失败"
          exit 1
        )
      
    - name: 准备发布文件
      run: |
        mkdir release
        copy target/x86_64-pc-windows-msvc/release/auto_backup.exe release/auto_backup_x64.exe
        copy target/i686-pc-windows-msvc/release/auto_backup.exe release/auto_backup_x32.exe
        
    - name: 上传构建产物
      uses: actions/upload-artifact@v4
      with:
        name: auto_backup
        path: release/
        if-no-files-found: error

    - name: 创建发布
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          release/auto_backup_x64.exe
          release/auto_backup_x32.exe
        fail_on_unmatched_files: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}